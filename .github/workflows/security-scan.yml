name: Security Scan

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # Run weekly security scan
    - cron: '0 0 * * 0'

jobs:
  secret-scan:
    name: Secret Detection
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run Gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Run TruffleHog
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD

  dependency-scan:
    name: Dependency Security
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Snyk Security Scan (Backend)
        uses: snyk/actions/python-3.11@master
        continue-on-error: true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --severity-threshold=high --file=backend/requirements.txt

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Run Snyk Security Scan (Frontend)
        uses: snyk/actions/node@master
        continue-on-error: true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --severity-threshold=high --file=frontend/package.json

  code-quality:
    name: Code Quality Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Python dependencies
        run: |
          cd backend
          pip install -r requirements.txt

      - name: Run Bandit (Python Security Linter)
        run: |
          pip install bandit
          bandit -r backend/ -f json -o bandit-report.json || true

      - name: Run Safety (Python Dependency Check)
        run: |
          pip install safety
          safety check --file=backend/requirements.txt --json || true

      - name: Upload Security Reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-reports
          path: |
            bandit-report.json
            gitleaks-report.json

  env-validation:
    name: Environment Validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for .env files
        run: |
          if find . -name "*.env" -not -name "*.env.example" | grep -q .; then
            echo "ERROR: .env files found in repository!"
            find . -name "*.env" -not -name "*.env.example"
            exit 1
          fi
          echo "✅ No .env files found"

      - name: Validate .env.example files
        run: |
          if [ ! -f "backend/.env.example" ]; then
            echo "ERROR: backend/.env.example not found!"
            exit 1
          fi
          if [ ! -f "frontend/.env.example" ]; then
            echo "ERROR: frontend/.env.example not found!"
            exit 1
          fi
          echo "✅ .env.example files present"

      - name: Check for hardcoded secrets
        run: |
          # Check for common secret patterns
          if grep -r -E "(password|secret|key|token)\s*=\s*['\"][^'\"]{8,}" --include="*.py" --include="*.ts" --include="*.tsx" --include="*.js" --include="*.jsx" backend/ frontend/ 2>/dev/null | grep -v "\.example" | grep -v "test" | grep -v "mock"; then
            echo "WARNING: Potential hardcoded secrets found"
            exit 1
          fi
          echo "✅ No obvious hardcoded secrets"
