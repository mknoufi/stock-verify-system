name: Lighthouse CI

on:
  push:
    branches: [main, develop]
    paths:
      - 'frontend/**'
      - '.github/workflows/lighthouse.yml'
  pull_request:
    branches: [main]
    paths:
      - 'frontend/**'

jobs:
  lighthouse:
    name: Lighthouse Performance Audit
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        working-directory: frontend
        run: npm ci

      - name: Build web version
        working-directory: frontend
        run: npm run build:web
        env:
          EXPO_PUBLIC_BACKEND_PORT: 8001
          EXPO_PUBLIC_API_TIMEOUT: 30000

      - name: Run Lighthouse CI
        uses: treosh/lighthouse-ci-action@v11
        with:
          uploadArtifacts: true
          temporaryPublicStorage: true
          configPath: ./frontend/lighthouserc.json
          budgetPath: ./frontend/budget.json

      - name: Check Lighthouse Scores
        uses: foo-software/lighthouse-check-action@v10.0.0
        with:
          accessToken: ${{ secrets.GITHUB_TOKEN }}
          prCommentEnabled: true
          prCommentSaveOld: true
          outputDirectory: ./lighthouse-results
          urls: |
            http://localhost:3000
            http://localhost:3000/login

      - name: Upload Lighthouse Report
        uses: actions/upload-artifact@v4
        with:
          name: lighthouse-report
          path: ./lighthouse-results
          retention-days: 30

      - name: Comment on PR with Lighthouse Results
        if: github.event_name == 'pull_request'
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: lighthouse
          path: ./lighthouse-results/lighthouse-summary.md

  performance-budgets:
    name: Performance Budget Check
    runs-on: ubuntu-latest
    needs: lighthouse

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download Lighthouse Report
        uses: actions/download-artifact@v4
        with:
          name: lighthouse-report
          path: ./lighthouse-results

      - name: Check Performance Budgets
        run: |
          # Parse Lighthouse results and check against thresholds
          PERFORMANCE=$(cat ./lighthouse-results/manifest.json | jq -r '.[0].summary.performance')
          ACCESSIBILITY=$(cat ./lighthouse-results/manifest.json | jq -r '.[0].summary.accessibility')
          BEST_PRACTICES=$(cat ./lighthouse-results/manifest.json | jq -r '.[0].summary["best-practices"]')
          SEO=$(cat ./lighthouse-results/manifest.json | jq -r '.[0].summary.seo')

          echo "ðŸ“Š Lighthouse Scores:"
          echo "  Performance: $PERFORMANCE"
          echo "  Accessibility: $ACCESSIBILITY"
          echo "  Best Practices: $BEST_PRACTICES"
          echo "  SEO: $SEO"

          # Threshold checks (0-1 scale)
          PERF_THRESHOLD=0.50
          A11Y_THRESHOLD=0.80
          BP_THRESHOLD=0.80
          SEO_THRESHOLD=0.80

          FAILED=false

          if (( $(echo "$PERFORMANCE < $PERF_THRESHOLD" | bc -l) )); then
            echo "âŒ Performance score ($PERFORMANCE) below threshold ($PERF_THRESHOLD)"
            FAILED=true
          fi

          if (( $(echo "$ACCESSIBILITY < $A11Y_THRESHOLD" | bc -l) )); then
            echo "âŒ Accessibility score ($ACCESSIBILITY) below threshold ($A11Y_THRESHOLD)"
            FAILED=true
          fi

          if (( $(echo "$BEST_PRACTICES < $BP_THRESHOLD" | bc -l) )); then
            echo "âŒ Best Practices score ($BEST_PRACTICES) below threshold ($BP_THRESHOLD)"
            FAILED=true
          fi

          if (( $(echo "$SEO < $SEO_THRESHOLD" | bc -l) )); then
            echo "âŒ SEO score ($SEO) below threshold ($SEO_THRESHOLD)"
            FAILED=true
          fi

          if [ "$FAILED" = true ]; then
            echo "::error::Performance budgets not met. Please review the Lighthouse report."
            exit 1
          fi

          echo "âœ… All performance budgets met!"
