# Copilot Instructions — Stock Verify Codebase

These rules help AI coding agents work productively and safely in this repo. Focus on the patterns actually used here; don’t introduce new frameworks or rewrite architecture.

## Project Snapshot
- **Backend**: FastAPI (Python 3.10+), MongoDB (Motor async), SQL Server (pyodbc, read-only).
- **Frontend**: React Native + Expo (TypeScript) with file-based routing and Zustand.
- **Ports**: Backend `8001`, Expo `8081` (LAN mode), Docker Frontend `3000`.
- **Core Files**:
  - `backend/server.py`: Main app entry point, router assembly.
  - `backend/config.py`: Pydantic settings, env var handling.
  - `backend/db_mapping_config.py`: SQL Server table/column mappings.
  - `frontend/src/services/api/api.ts`: Frontend API layer with offline/online logic.

## Architecture Essentials
- **Multi-DB Strategy**:
  - **MongoDB**: Primary write store (app state, sessions, counts).
  - **SQL Server**: Read-only ERP source. **NEVER** write to SQL Server.
  - **Sync**: Data flows SQL -> Mongo. Use `SQLSyncService` for synchronization.
- **Auth**: JWT required for `/api/*`. Use `Depends(get_current_user)` in FastAPI. Frontend stores token in `authStore`.
- **Offline-First**: Frontend uses a 3-state network model (Online, Offline, Degraded). Writes go to `offlineQueue` if offline.
- **Dynamic Systems**: Reports and fields are config-driven (`backend/api/dynamic_*`). Avoid hardcoding report schemas.

## Critical Developer Workflows
- **Startup**:
  - `make start`: Runs backend + frontend (LAN mode).
  - `make backend`: Backend only (port 8001).
  - `make frontend`: Frontend only (port 8081).
- **Testing**:
  - **Backend**: `make python-test` (pytest). **Mandatory** for logic changes.
  - **Frontend**: `npm test` (Jest).
  - **CI**: `make ci` runs all checks.
- **Linting/Formatting**:
  - `make python-format` / `make python-lint` (Ruff/Black).
  - `make node-lint` (ESLint).
- **Debugging**:
  - Backend logs to stdout. Use `uvicorn` directly for debugger attachment if needed.
  - Frontend logs via `createLogger` in `src/services/logging`.

## Conventions & Patterns
- **API Design**:
  - Prefix: `/api/v1` or `/api/v2` (enhanced).
  - Response Shape: `{ data: ..., meta: ... }` or standard error shape.
  - **SQL Access**: **ALWAYS** use parameterized queries (`?` placeholders). **NEVER** f-string SQL.
    - See `backend/db_mapping_config.py` for query templates.
- **Barcode Handling**:
  - Strict 6-digit numeric rule for ERP items (prefixes 51, 52, 53).
  - Use `_normalize_barcode_input` (backend) or `validateBarcode` (frontend).
- **Frontend Data Flow**:
  - API responses are normalized in `api.ts` before reaching components.
  - Check `ApiResponseWithSource` interface for data freshness metadata (`_source`, `_cachedAt`).
- **Configuration**:
  - Backend: `backend/config.py` handles `MONGO_URL` detection and validation.
  - Frontend: `backend_port.json` is generated by backend to tell frontend where to connect (LAN IP).

## Integration Points
- **ERP Mapping**:
  - `backend/db_mapping_config.py` defines `TABLE_MAPPINGS` and `COLUMN_MAP`.
  - `backend/api/mapping_api.py` exposes endpoints to test SQL connections and mappings.
- **Enhanced Lookups**:
  - `backend/api/enhanced_item_api.py` (V2) adds caching and monitoring to item lookups.
  - Prefer V2 endpoints (`/api/v2/erp/items/...`) for new features.

## Guardrails for AI Agents
- **Safety**:
  - **NO** writes to SQL Server.
  - **NO** CORS wildcards (`*`). Use `CORS_ALLOW_ORIGINS`.
  - **NO** hardcoded secrets. Use `backend/config.py` / `.env`.
- **Verification**:
  - Run `make python-test` after backend changes.
  - Run `npm typecheck` after frontend changes.
- **Scope**:
  - Respect `files.read_only` in `.clinerules` (e.g., `.env`, keys).
  - Do not modify `docker-compose.yml` without explicit instruction.

## References
- `backend/db_mapping_config.py`: SQL query templates and schema maps.
- `backend/api/enhanced_item_api.py`: Example of V2 API pattern.
- `frontend/src/services/api/api.ts`: Example of offline-aware fetch logic.
- `Makefile`: All runnable commands.
