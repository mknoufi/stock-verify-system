<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Lavanya E-Mart • Supervisor Dashboard (Web)</title>
  <style>
    :root {
      color-scheme: dark;
      --bg: #0a0a0a;
      --card: #161616;
      --card-border: #222;
      --accent: #4caf50;
      --accent-soft: rgba(76, 175, 80, 0.12);
      --text: #f5f5f5;
      --text-muted: #9e9e9e;
      --error: #ff5252;
      --warning: #ffb74d;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 24px 12px 48px;
      gap: 24px;
    }

    h1 {
      margin: 0;
      font-size: clamp(28px, 4vw, 40px);
      text-align: center;
    }

    .subtitle {
      margin: 0;
      font-size: clamp(16px, 2.5vw, 20px);
      color: var(--accent);
      text-align: center;
    }

    .panel {
      width: min(1100px, 96vw);
      background: var(--card);
      border: 1px solid var(--card-border);
      border-radius: 16px;
      padding: 24px;
      display: flex;
      flex-direction: column;
      gap: 16px;
      box-shadow: 0 15px 40px rgba(0, 0, 0, 0.35);
    }

    .panel.hidden {
      display: none;
    }

    .panel h2 {
      margin: 0;
      font-size: 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }

    .panel-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
    }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 16px;
    }

    label {
      display: flex;
      flex-direction: column;
      gap: 6px;
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--text-muted);
    }

    input[type="text"],
    input[type="password"] {
      background: #111;
      border: 1px solid #2a2a2a;
      border-radius: 10px;
      padding: 12px 14px;
      color: var(--text);
      font-size: 15px;
    }

    input[type="text"]:focus,
    input[type="password"]:focus {
      border-color: var(--accent);
      outline: none;
      box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.3);
    }

    button {
      background: var(--accent);
      color: #0d0d0d;
      border: none;
      border-radius: 10px;
      padding: 12px 20px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.15s ease, box-shadow 0.15s ease;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      justify-content: center;
    }

    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(76, 175, 80, 0.25);
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .button-row {
      display: flex;
      gap: 12px;
      align-items: center;
      flex-wrap: wrap;
    }

    .ghost {
      background: #2d2d2d;
      color: var(--text);
    }

    .status {
      padding: 12px 16px;
      border-radius: 12px;
      font-size: 14px;
      display: none;
      align-items: center;
      gap: 10px;
    }

    .status.visible {
      display: inline-flex;
    }

    .status.error {
      background: rgba(255, 82, 82, 0.12);
      color: var(--error);
      border: 1px solid rgba(255, 82, 82, 0.35);
    }

    .status.success {
      background: rgba(76, 175, 80, 0.12);
      color: var(--accent);
      border: 1px solid rgba(76, 175, 80, 0.35);
    }

    .summary-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 16px;
    }

    .summary-card {
      background: #1f1f1f;
      border-radius: 14px;
      border: 1px solid #2b2b2b;
      padding: 18px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .summary-label {
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--text-muted);
    }

    .summary-value {
      font-size: 26px;
      font-weight: 700;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      border-radius: 14px;
      overflow: hidden;
      border: 1px solid #242424;
      background: #131313;
    }

    thead {
      background: rgba(255, 255, 255, 0.03);
      text-transform: uppercase;
      letter-spacing: 0.6px;
      font-size: 12px;
      color: var(--text-muted);
    }

    th,
    td {
      padding: 14px 16px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.04);
      text-align: left;
      font-size: 14px;
    }

    tbody tr:hover {
      background: rgba(255, 255, 255, 0.04);
    }

    .table-wrapper {
      overflow-x: auto;
    }

    .badge {
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }

    .badge.open { background: rgba(76, 175, 80, 0.15); color: var(--accent); }
    .badge.reconcile { background: rgba(255, 183, 77, 0.15); color: var(--warning); }
    .badge.closed { background: rgba(158, 158, 158, 0.12); color: #bdbdbd; }

    .notices {
      background: rgba(255, 183, 77, 0.08);
      border: 1px solid rgba(255, 183, 77, 0.4);
      border-radius: 12px;
      padding: 16px;
      color: var(--warning);
      font-size: 14px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .muted {
      color: var(--text-muted);
      font-size: 13px;
    }

    .empty {
      text-align: center;
      padding: 32px;
      color: var(--text-muted);
    }
  </style>
</head>
<body>
  <header>
    <h1>Lavanya E-Mart</h1>
    <p class="subtitle">Supervisor Dashboard – Web Access</p>
  </header>

  <section class="panel" id="auth-panel">
    <h2>Step 1 · Connect to Backend</h2>
    <div class="form-grid">
      <label>
        Backend API URL
        <input type="text" id="backend-url" value="http://192.168.1.41:8000/api" />
      </label>
      <label>
        Username
        <input type="text" id="username" placeholder="supervisor" />
      </label>
      <label>
        Password
        <input type="password" id="password" placeholder="Enter password" />
      </label>
    </div>
    <div class="button-row">
      <button id="login-btn">Sign In</button>
      <span id="login-status" class="status"></span>
    </div>
    <p class="muted">
      Uses the existing REST API (same as mobile). Credentials never leave your network.
    </p>
  </section>

  <section class="panel hidden" id="dashboard-panel">
    <header class="panel-header">
      <h2>Stock Sessions</h2>
  <div class="button-row">
    <button id="refresh-btn">Refresh</button>
    <button id="logout-btn" class="ghost">Logout</button>
  </div>
    </header>

    <div class="summary-grid" id="summary-grid">
      <div class="summary-card">
        <span class="summary-label">Total Sessions</span>
        <span class="summary-value" id="total-sessions">—</span>
      </div>
      <div class="summary-card">
        <span class="summary-label">Active Sessions</span>
        <span class="summary-value" id="open-sessions">—</span>
      </div>
      <div class="summary-card">
        <span class="summary-label">Items Counted</span>
        <span class="summary-value" id="total-items">—</span>
      </div>
      <div class="summary-card">
        <span class="summary-label">Total Variance</span>
        <span class="summary-value" id="total-variance">—</span>
      </div>
    </div>

    <div class="notices" id="web-limits">
      <strong>Heads up:</strong>
      <span>Web view is read-only. All scanning, photo proof, and count edits remain mobile-only.</span>
      <span class="muted">Backend activity is live. Refresh to pull the latest stock counts.</span>
    </div>

    <div class="table-wrapper">
      <table>
        <thead>
          <tr>
            <th>Warehouse</th>
            <th>Session</th>
            <th>Status</th>
            <th>Staff</th>
            <th>Items</th>
            <th>Variance</th>
            <th>Updated</th>
          </tr>
        </thead>
        <tbody id="sessions-body">
          <tr><td colspan="7" class="empty">No data yet. Click "Refresh" once logged in.</td></tr>
        </tbody>
      </table>
    </div>
  </section>

  <script>
    const backendInput = document.getElementById('backend-url');
    const usernameInput = document.getElementById('username');
    const passwordInput = document.getElementById('password');
    const loginBtn = document.getElementById('login-btn');
    const loginStatus = document.getElementById('login-status');
    const dashboardPanel = document.getElementById('dashboard-panel');
    const authPanel = document.getElementById('auth-panel');
    const refreshBtn = document.getElementById('refresh-btn');
    const logoutBtn = document.getElementById('logout-btn');
    const sessionsBody = document.getElementById('sessions-body');
    const totalSessionsEl = document.getElementById('total-sessions');
    const openSessionsEl = document.getElementById('open-sessions');
    const totalItemsEl = document.getElementById('total-items');
    const totalVarianceEl = document.getElementById('total-variance');

    let authToken = localStorage.getItem('supervisor_token') || '';
    let refreshToken = localStorage.getItem('supervisor_refresh') || '';
    let backendUrl = localStorage.getItem('supervisor_backend') || backendInput.value;

    backendInput.value = backendUrl;

    const setStatus = (element, message, type) => {
      element.textContent = message;
      element.className = `status visible ${type}`;
    };

    const clearStatus = (element) => {
      element.className = 'status';
      element.textContent = '';
    };

    const formatNumber = (value) => {
      if (value === null || value === undefined) return '—';
      if (typeof value === 'number') {
        return value.toLocaleString(undefined, { maximumFractionDigits: 2 });
      }
      return String(value);
    };

    const formatDateTime = (timestamp) => {
      if (!timestamp) return '—';
      const date = new Date(timestamp);
      if (Number.isNaN(date.getTime())) return timestamp;
      return date.toLocaleString();
    };

    const sessionStatusClass = (status) => {
      switch ((status || '').toUpperCase()) {
        case 'OPEN':
          return 'badge open';
        case 'RECONCILE':
          return 'badge reconcile';
        default:
          return 'badge closed';
      }
    };

    const saveAuth = () => {
      if (authToken) {
        localStorage.setItem('supervisor_token', authToken);
      }
      if (refreshToken) {
        localStorage.setItem('supervisor_refresh', refreshToken);
      }
      localStorage.setItem('supervisor_backend', backendUrl);
    };

    const clearAuth = () => {
      authToken = '';
      refreshToken = '';
      localStorage.removeItem('supervisor_token');
      localStorage.removeItem('supervisor_refresh');
    };

    const apiFetch = async (path, options = {}) => {
      const url = `${backendUrl.replace(/\/$/, '')}${path.startsWith('/') ? path : `/${path}`}`;
      const headers = {
        'Content-Type': 'application/json',
        ...(options.headers || {}),
      };
      if (authToken) {
        headers.Authorization = `Bearer ${authToken}`;
      }

      const response = await fetch(url, {
        ...options,
        headers,
      });

      if (response.status === 401 && refreshToken) {
        const refreshed = await refreshSession();
        if (refreshed) {
          return apiFetch(path, options);
        }
      }

      if (!response.ok) {
        const text = await response.text();
        throw new Error(text || `Request failed with status ${response.status}`);
      }

      if (response.status === 204) {
        return null;
      }

      const data = await response.json();
      return data;
    };

    const refreshSession = async () => {
      if (!refreshToken) return false;
      try {
        const data = await apiFetch('/auth/refresh', {
          method: 'POST',
          body: JSON.stringify({ refresh_token: refreshToken }),
          headers: { Authorization: '' },
        });
        authToken = data.access_token;
        refreshToken = data.refresh_token || refreshToken;
        saveAuth();
        setStatus(loginStatus, 'Session refreshed.', 'success');
        return true;
      } catch (error) {
        console.error('Refresh error:', error);
        setStatus(loginStatus, 'Session expired. Please login again.', 'error');
        clearAuth();
        dashboardPanel.classList.add('hidden');
        authPanel.classList.remove('hidden');
        return false;
      }
    };

    const updateSummary = (sessions = []) => {
      const totals = sessions.reduce(
        (acc, session) => {
          const variance = Number(session.total_variance || 0);
          const items = Number(session.total_items || 0);
          acc.totalVariance += Number.isFinite(variance) ? variance : 0;
          acc.totalItems += Number.isFinite(items) ? items : 0;
          if ((session.status || '').toUpperCase() === 'OPEN') {
            acc.openSessions += 1;
          }
          return acc;
        },
        { totalVariance: 0, totalItems: 0, openSessions: 0 }
      );

      totalSessionsEl.textContent = formatNumber(sessions.length);
      openSessionsEl.textContent = formatNumber(totals.openSessions);
      totalItemsEl.textContent = formatNumber(totals.totalItems);
      totalVarianceEl.textContent = formatNumber(totals.totalVariance);
    };

    const renderSessions = (sessions = []) => {
      if (!sessions.length) {
        sessionsBody.innerHTML = '<tr><td colspan="7" class="empty">No sessions available.</td></tr>';
        updateSummary([]);
        return;
      }

      const rows = sessions
        .map((session) => {
          return `
            <tr>
              <td>${session.warehouse || '—'}</td>
              <td>${session.id || session.session_id || '—'}</td>
              <td><span class="${sessionStatusClass(session.status)}">${session.status || '—'}</span></td>
              <td>${session.staff_name || session.created_by || '—'}</td>
              <td>${formatNumber(session.total_items)}</td>
              <td>${formatNumber(session.total_variance)}</td>
              <td>${formatDateTime(session.updated_at || session.completed_at || session.started_at)}</td>
            </tr>
          `;
        })
        .join('');

      sessionsBody.innerHTML = rows;
      updateSummary(sessions);
    };

    const loadSessions = async () => {
      try {
        refreshBtn.disabled = true;
        refreshBtn.textContent = 'Refreshing…';
        const data = await apiFetch('/sessions?page=1&page_size=200');
        const sessions = Array.isArray(data) ? data : data.items || [];
        renderSessions(sessions);
        setStatus(loginStatus, `Fetched ${sessions.length} session(s).`, 'success');
      } catch (error) {
        console.error('Load sessions error:', error);
        setStatus(loginStatus, error.message || 'Failed to load sessions.', 'error');
      } finally {
        refreshBtn.disabled = false;
        refreshBtn.textContent = 'Refresh';
      }
    };

    const attemptAutoLogin = async () => {
      if (!authToken) return;
      try {
        setStatus(loginStatus, 'Restoring session…', 'success');
        await loadSessions();
        authPanel.classList.add('hidden');
        dashboardPanel.classList.remove('hidden');
      } catch (error) {
        console.warn('Auto login failed:', error);
        clearAuth();
      }
    };

    loginBtn.addEventListener('click', async () => {
      clearStatus(loginStatus);
      backendUrl = backendInput.value.trim();
      const username = usernameInput.value.trim();
      const password = passwordInput.value;

      if (!backendUrl || !username || !password) {
        setStatus(loginStatus, 'Enter backend URL, username, and password.', 'error');
        return;
      }

      try {
        loginBtn.disabled = true;
        loginBtn.textContent = 'Signing In…';
        setStatus(loginStatus, 'Contacting server…', 'success');

        const data = await apiFetch('/auth/login', {
          method: 'POST',
          body: JSON.stringify({ username, password }),
          headers: { Authorization: '' },
        });

        authToken = data.access_token;
        refreshToken = data.refresh_token;
        saveAuth();

        setStatus(loginStatus, `Welcome ${data.user?.full_name || username}!`, 'success');
        authPanel.classList.add('hidden');
        dashboardPanel.classList.remove('hidden');
        await loadSessions();
      } catch (error) {
        console.error('Login error:', error);
        setStatus(loginStatus, error.message || 'Login failed.', 'error');
        clearAuth();
      } finally {
        loginBtn.disabled = false;
        loginBtn.textContent = 'Sign In';
      }
    });

    refreshBtn.addEventListener('click', loadSessions);

    logoutBtn.addEventListener('click', () => {
      clearAuth();
      dashboardPanel.classList.add('hidden');
      authPanel.classList.remove('hidden');
      sessionsBody.innerHTML = '<tr><td colspan="7" class="empty">Logged out.</td></tr>';
      updateSummary([]);
      setStatus(loginStatus, 'Logged out.', 'success');
    });

    attemptAutoLogin();
  </script>
</body>
</html>
