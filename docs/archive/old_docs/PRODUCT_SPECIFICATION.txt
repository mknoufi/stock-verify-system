# STOCK_VERIFY Product Specification Document

**Version:** 2.0
**Last Updated:** 2025-01-12
**Status:** Production Ready
**Target ERPNext Version:** v15+

---

## Table of Contents

1. Executive Summary
2. Product Overview
3. User Roles & Personas
4. Core Features
5. Technical Architecture
6. API Specifications
7. User Stories & Use Cases
8. Non-Functional Requirements
9. Integration Requirements
10. Security & Compliance
11. Deployment & Infrastructure
12. Future Roadmap

---

## Executive Summary

STOCK_VERIFY is a full-stack stock verification companion application designed for ERPNext v15+ systems. It enables mobile-first stock counting operations with real-time synchronization, role-based access control, and comprehensive reporting capabilities.

### Key Value Propositions

- Mobile-First Design: Native mobile app (iOS/Android) optimized for warehouse operations
- ERPNext Integration: Seamless read-only integration with ERPNext SQL Server database
- Real-Time Sync: Live synchronization of stock data between ERPNext and verification system
- Role-Based Access: Granular permissions for Staff, Supervisor, and Admin roles
- Offline Capability: Queue operations when offline, sync when connection restored
- Comprehensive Reporting: Dynamic reports and analytics for inventory insights

### Target Market

- Medium to large enterprises using ERPNext for inventory management
- Warehouse operations requiring mobile stock verification
- Organizations needing audit trails and compliance reporting
- Multi-warehouse operations with distributed teams

---

## Product Overview

### Product Vision

To provide a seamless, mobile-first stock verification solution that integrates with ERPNext, enabling accurate inventory counts, real-time synchronization, and comprehensive reporting while maintaining data integrity and security.

### Product Mission

Empower warehouse staff, supervisors, and administrators with intuitive tools for stock verification, enabling faster counts, reduced errors, and improved inventory accuracy.

### Product Goals

1. Accuracy: Reduce stock counting errors by 90% through barcode scanning and validation
2. Efficiency: Enable 3x faster stock counting operations compared to manual processes
3. Visibility: Provide real-time visibility into stock verification status and progress
4. Compliance: Maintain complete audit trails for regulatory compliance
5. Scalability: Support multiple warehouses and concurrent users

---

## 3. User Roles & Personas

### 3.1 Staff Role

**Persona:** Warehouse Operator
**Primary Responsibilities:**
- Perform daily stock counting operations
- Scan barcodes and verify item quantities
- Record item conditions and locations
- Capture photos as proof of verification

**Key Permissions:**
- session.create, session.read, session.update, session.close
- count_line.create, count_line.read, count_line.update
- item.read, item.search, mrp.update
- export.own, review.create, review.comment

**Use Cases:**
- Scan barcode to identify item
- Enter verified quantity
- Record damaged quantities (returnable/non-returnable)
- Update item location (floor/rack)
- Capture photo evidence
- Submit verification for review

### 3.2 Supervisor Role

**Persona:** Warehouse Supervisor
**Primary Responsibilities:**
- Oversee stock verification operations
- Review and approve/reject verifications
- Manage multiple sessions
- Generate reports and analytics
- Resolve sync conflicts

**Key Permissions:**
- All Staff permissions plus:
- session.read_all, session.delete
- count_line.delete, count_line.approve, count_line.reject
- mrp.bulk_update, export.all, export.schedule
- activity_log.read, error_log.read
- db_mapping.manage, sync.trigger, sync.resolve_conflict
- review.approve, report.view, report.financial, report.analytics

**Use Cases:**
- Review pending verifications
- Approve or reject stock counts
- View variance reports
- Trigger manual ERP synchronization
- Export verification data
- Monitor activity logs
- Resolve data conflicts

### 3.3 Admin Role

**Persona:** System Administrator
**Primary Responsibilities:**
- System configuration and management
- User management
- Database mapping configuration
- System monitoring and maintenance
- Full system access

**Key Permissions:**
- All permissions (full access)
- user.manage, settings.manage, db_mapping.manage

**Use Cases:**
- Create and manage user accounts
- Configure system settings
- Manage database mappings
- Monitor system health
- Configure dynamic fields and reports
- Access all system features

---

## 4. Core Features

### 4.1 Authentication & Authorization (F001 - High Priority)

JWT-based authentication system with role-based access control (RBAC). Supports secure login, token refresh, and granular permission management.

**Key Components:**
- JWT token generation and validation
- Role-based permission system
- Token refresh mechanism
- Session management
- Password hashing (bcrypt)

### 4.2 Barcode Scanning (F002 - High Priority)

Mobile barcode scanning capability using device camera to quickly identify items during stock verification.

**Key Components:**
- Expo Barcode Scanner integration
- Camera permission handling
- Barcode format support (EAN-13, Code128, QR codes)
- Item lookup by barcode
- Offline barcode caching

### 4.3 Stock Verification (F003 - High Priority)

Core feature for verifying stock quantities with support for multiple verification states and item conditions.

**Verification Fields:**
- Verified Quantity (Good stock)
- Damaged Quantity (Returnable)
- Non-Returnable Damaged Quantity
- Item Condition (Good/Damaged/Expired)
- Serial Number
- Floor Location
- Rack Location
- Photo Evidence

**Variance Calculation:**
Variance = (Verified Qty + Damaged Qty) - System Qty

### 4.4 Stock Sessions (F004 - High Priority)

Organize stock verification activities into sessions for better tracking and reporting.

**Session Metadata:**
- Session ID, Name/Description
- Created By, Created At
- Status (open/closed)
- Warehouse
- Count Lines Count
- Verified Count Lines Count

### 4.5 Variance Tracking (F005 - Medium Priority)

Track differences between system quantities and verified quantities, including financial impact calculations.

**Financial Impact:**
Financial Impact = (Counted MRP × Counted Qty) - (System MRP × System Qty)

### 4.6 ERPNext Integration & Synchronization (F006 - High Priority)

Read-only integration with ERPNext SQL Server database for item/master data synchronization.

**Sync Strategy:**
- Pull-based: Backend queries ERPNext for item/master data
- Scheduled: Automatic sync every hour (configurable)
- Manual: Supervisor/Admin can trigger sync
- Conflict Resolution: Detects and flags conflicts for manual resolution

**Synced Data:**
- Item Code, Item Name, Barcode
- Stock Quantity, MRP
- Category/Subcategory, Warehouse
- Unit of Measure (UOM)
- Floor/Rack Location

### 4.7 Dynamic Fields (F007 - Medium Priority)

Configurable field system allowing administrators to add custom fields to verification forms without code changes.

**Field Types:** Text, Number, Date, Select (dropdown), Boolean

### 4.8 Dynamic Reports (F008 - Medium Priority)

Configurable reporting system for generating custom reports based on verification data.

**Report Types:**
- Verification Summary
- Variance Reports
- Financial Impact Reports
- Item-wise Reports
- User Activity Reports

### 4.9 Export Functionality (F009 - Medium Priority)

Export verification data in various formats for external analysis and reporting.

**Export Formats:** CSV, JSON
**Export Scopes:** Own data (Staff), All data (Supervisor/Admin), Session-based, Date range

### 4.10 Activity Logging (F010 - Medium Priority)

Comprehensive audit trail of all user actions for compliance and troubleshooting.

**Logged Actions:**
- Login/Logout
- Session creation/closure
- Count line creation/update
- Stock verification
- Approval/Rejection
- Export operations
- System configuration changes

### 4.11 Offline Support (F011 - Medium Priority)

Queue operations when offline and automatically sync when connection is restored.

**Offline Capabilities:**
- Create count lines
- Update verifications
- Capture photos
- Queue exports

### 4.12 Review & Approval Workflow (F012 - Medium Priority)

Supervisor review and approval system for stock verifications.

**Workflow:**
1. Staff completes verification
2. Verification marked as "pending review"
3. Supervisor reviews verification
4. Supervisor approves or rejects with comments
5. Staff notified of decision

---

## 5. Technical Architecture

### 5.1 System Architecture

Mobile App (React Native/Expo) → FastAPI Backend → MongoDB (Primary) + SQL Server (ERPNext Read-Only)

### 5.2 Technology Stack

**Backend:**
- Framework: FastAPI 0.115+
- Language: Python 3.10+
- Database: MongoDB (primary), SQL Server (read-only ERPNext connection)
- Authentication: JWT (PyJWT)
- Password Hashing: bcrypt
- Async Framework: asyncio, motor (MongoDB async driver)
- Validation: Pydantic

**Frontend:**
- Framework: React Native 0.81.5
- Platform: Expo ~54.0
- Language: TypeScript 5.9
- State Management: Zustand
- API Client: Axios
- Storage: AsyncStorage
- Routing: Expo Router (file-based)
- Barcode Scanner: expo-barcode-scanner
- Camera: expo-camera

**Infrastructure:**
- Reverse Proxy: Nginx
- Containerization: Docker (optional)
- Process Management: systemd (Linux), PM2 (optional)

### 5.3 Database Schema

**MongoDB Collections:**
- erp_items: Item data synced from ERPNext
- sessions: Stock verification sessions
- count_lines: Individual verification records
- users: User accounts and permissions
- activity_logs: Audit trail
- dynamic_fields: Configurable field definitions
- dynamic_reports: Report definitions

**Key Fields:**
- erp_items: item_code, item_name, barcode, stock_qty, mrp, verified_qty, variance
- sessions: id, name, created_by, status, warehouse
- count_lines: id, session_id, item_code, verified_qty, variance, verified

### 5.4 API Architecture

**Base URL:** http://localhost:8000 (development)
**API Prefix:** /api/v1
**Authentication:** JWT Bearer token

**Endpoint Categories:**
1. Authentication (/api/v1/auth/*)
2. Items (/api/v1/items/*)
3. Sessions (/api/v1/sessions/*)
4. Count Lines (/api/v1/count-lines/*)
5. Verification (/api/v1/verification/*)
6. Admin (/api/v1/admin/*)
7. Dynamic Fields (/api/v1/dynamic-fields/*)
8. Dynamic Reports (/api/v1/dynamic-reports/*)
9. Export (/api/v1/export/*)
10. Health (/api/v1/health)

See API_CONTRACTS.md for detailed API specifications.

---

## 6. API Specifications

See API_CONTRACTS.md for complete API documentation including:
- Authentication endpoints
- Item endpoints
- Session endpoints
- Count line endpoints
- Verification endpoints
- Admin endpoints
- Dynamic fields/reports endpoints
- Health and status endpoints
- Error response formats
- Rate limiting
- Pagination

---

## 7. User Stories & Use Cases

### 7.1 Staff User Stories

**US-001:** As a Staff member, I want to scan a barcode to identify an item quickly
**US-002:** As a Staff member, I want to verify stock quantities
**US-003:** As a Staff member, I want to record damaged items
**US-004:** As a Staff member, I want to capture photos as proof
**US-005:** As a Staff member, I want to work offline
**US-006:** As a Staff member, I want to create a new verification session

### 7.2 Supervisor User Stories

**US-007:** As a Supervisor, I want to review pending verifications
**US-008:** As a Supervisor, I want to approve or reject verifications
**US-009:** As a Supervisor, I want to view variance reports
**US-010:** As a Supervisor, I want to export verification data
**US-011:** As a Supervisor, I want to trigger manual ERP sync
**US-012:** As a Supervisor, I want to view activity logs

### 7.3 Admin User Stories

**US-013:** As an Admin, I want to manage users
**US-014:** As an Admin, I want to configure system settings
**US-015:** As an Admin, I want to configure database mappings
**US-016:** As an Admin, I want to configure dynamic fields
**US-017:** As an Admin, I want to create custom reports
**US-018:** As an Admin, I want to monitor system health

### 7.4 Use Case Scenarios

**UC-001: Complete Stock Verification Workflow**
1. Staff logs into mobile app
2. Staff creates new verification session
3. Staff scans item barcode
4. System displays item details
5. Staff enters verified quantity
6. Staff records damaged quantities (if any)
7. Staff captures photo evidence
8. Staff updates item location
9. Staff submits verification
10. Supervisor reviews and approves
11. Variance calculated and stored

**UC-002: Offline Verification Workflow**
1. Staff starts verification while online
2. Connection lost during operation
3. Staff continues verifying items
4. Operations queued locally
5. Connection restored
6. System automatically syncs queued operations

**UC-003: Variance Investigation Workflow**
1. Supervisor views variance report
2. Supervisor identifies high-variance items
3. Supervisor reviews verification details
4. Supervisor checks activity logs
5. Supervisor approves or rejects based on investigation

**UC-004: ERP Sync Workflow**
1. System automatically syncs at scheduled time
2. System fetches items from ERPNext SQL Server
3. System transforms and stores data in MongoDB
4. System detects conflicts (if any)
5. Supervisor reviews and resolves conflicts

---

## 8. Non-Functional Requirements

### 8.1 Performance Requirements

**Response Time:**
- API response time: < 200ms (p95)
- Barcode scan recognition: < 500ms
- Page load time: < 2 seconds
- Report generation: < 5 seconds (for up to 10,000 records)

**Throughput:**
- Support 100 concurrent users
- Handle 1000 API requests per minute
- Process 500 barcode scans per minute

**Scalability:**
- Support up to 1 million items
- Support up to 10,000 active sessions
- Support up to 100,000 count lines per session

### 8.2 Reliability Requirements

**Availability:**
- System uptime: 99.5% (excluding planned maintenance)
- Graceful degradation when ERPNext is unavailable
- Offline capability for mobile app

**Error Handling:**
- All errors logged with context
- User-friendly error messages
- Automatic retry for transient failures
- Data validation at all layers

**Data Integrity:**
- Transaction support for critical operations
- Data validation before storage
- Referential integrity checks
- Audit trail for all data changes

### 8.3 Usability Requirements

**User Interface:**
- Intuitive navigation
- Touch-friendly buttons (minimum 44x44 points)
- Clear visual feedback
- Consistent design language
- Accessibility support

**Mobile Experience:**
- Responsive design for various screen sizes
- Optimized for portrait orientation
- Fast camera access for barcode scanning
- Smooth animations and transitions

### 8.4 Security Requirements

**Authentication:**
- Secure password storage (bcrypt hashing)
- JWT token expiration (24 hours access, 7 days refresh)
- Token revocation support
- Session timeout after inactivity

**Authorization:**
- Role-based access control (RBAC)
- Permission-based feature access
- API endpoint protection
- Data access restrictions based on role

**Data Protection:**
- HTTPS in production
- Encrypted data at rest (database)
- Secure credential storage
- Input sanitization
- SQL injection prevention

**Audit & Compliance:**
- Complete activity logging
- IP address and user agent tracking
- Audit trail for all data changes
- Compliance with data protection regulations

### 8.5 Maintainability Requirements

**Code Quality:**
- TypeScript strict mode
- Python type hints
- Code documentation
- Unit test coverage > 80%
- Integration tests for critical paths

**Monitoring:**
- Health check endpoints
- Error logging and alerting
- Performance metrics
- Usage analytics

---

## 9. Integration Requirements

### 9.1 ERPNext Integration

**Connection Type:** Read-only SQL Server connection

**Data Flow:**
1. ERPNext stores data in SQL Server
2. STOCK_VERIFY connects to SQL Server (read-only user)
3. STOCK_VERIFY syncs item/master data periodically
4. STOCK_VERIFY stores synced data in MongoDB
5. Mobile app reads from MongoDB via API

**Synchronized Data:**
- Items (item_code, item_name, barcode)
- Stock quantities (warehouse-wise)
- MRP (Maximum Retail Price)
- Categories and subcategories
- Warehouse information
- Unit of Measure (UOM)
- Location data (floor/rack)

**Sync Frequency:**
- Default: Every 1 hour (configurable)
- Manual trigger: On-demand by Supervisor/Admin

**Conflict Resolution:**
- Automatic detection of conflicts
- Manual resolution by Supervisor
- Conflict history tracking
- Resolution audit trail

### 9.2 Database Integration

**MongoDB:**
- Primary database for stock verification data
- Stores sessions, count lines, users, activity logs
- Supports horizontal scaling
- Indexed for performance

**SQL Server (ERPNext):**
- Read-only connection
- Source of truth for item/master data
- Connection pooling for efficiency
- Query optimization for large datasets

---

## 10. Security & Compliance

### 10.1 Security Measures

**Authentication Security:**
- Password requirements: Minimum 8 characters, alphanumeric
- Password hashing: bcrypt with salt rounds = 12
- JWT token: HS256 algorithm, 24-hour expiration
- Refresh token: 7-day expiration
- Token storage: Secure storage (AsyncStorage with encryption)

**Authorization Security:**
- Role-based access control (RBAC)
- Permission-based feature access
- API endpoint protection
- Data access restrictions

**Network Security:**
- HTTPS/TLS 1.2+ in production
- CORS configuration
- Rate limiting (100 req/min per IP)
- Request size limits
- Security headers

**Data Security:**
- Input validation and sanitization
- SQL injection prevention (parameterized queries)
- XSS prevention
- CSRF protection
- Sensitive data encryption at rest

### 10.2 Compliance

**Data Protection:**
- User data privacy
- Audit trails for compliance
- Data retention policies
- Right to deletion support

**Audit Requirements:**
- Complete activity logging
- User action tracking
- System change tracking
- Access log retention (configurable)

**Regulatory Compliance:**
- GDPR compliance (data protection)
- Industry-specific regulations (as applicable)
- Financial audit requirements
- Inventory audit requirements

---

## 11. Deployment & Infrastructure

### 11.1 Development Environment

**Requirements:**
- Python 3.10+
- Node.js 18+
- MongoDB 5.0+
- SQL Server access (read-only)
- Expo CLI

**Setup:**
1. Clone repository
2. Install Python dependencies (pip install -r requirements.txt)
3. Install Node dependencies (npm install)
4. Configure environment variables
5. Start MongoDB
6. Configure SQL Server connection
7. Run backend (uvicorn backend.server:app --reload)
8. Run frontend (npm start)

### 11.2 Production Environment

**Infrastructure:**
- Backend: FastAPI on uvicorn/gunicorn
- Frontend: Expo build (iOS/Android apps)
- Database: MongoDB cluster (replica set)
- Reverse Proxy: Nginx
- Process Management: systemd or PM2
- Monitoring: Health checks, logs, metrics

**Deployment Options:**
1. Traditional Server: Backend on Linux server, MongoDB on same or separate server, Nginx reverse proxy, systemd services
2. Docker: Docker Compose for full stack, separate containers for backend/MongoDB, Nginx container
3. Cloud: Backend on cloud VM or container service, Managed MongoDB (MongoDB Atlas), Cloud storage for photos

**Environment Variables:**
- Database connection strings
- JWT secret key
- ERPNext SQL Server credentials
- API keys for external services
- Environment (development/staging/production)

**Monitoring:**
- Health check endpoints
- Error logging (centralized)
- Performance metrics
- Usage analytics
- Alerting for critical issues

**Backup & Recovery:**
- MongoDB backups (daily)
- Configuration backups
- Disaster recovery plan
- Data retention policies

---

## 12. Future Roadmap

### Phase 1: Enhanced Features (Q1 2025)

**Real-Time Synchronization:**
- WebSocket support for real-time updates
- Server-Sent Events (SSE) for live data
- Push notifications for mobile app

**Advanced Reporting:**
- Chart visualizations
- Custom dashboard widgets
- Scheduled report delivery
- Export to multiple formats (PDF, Excel)

**Barcode Enhancements:**
- Support for more barcode formats
- Batch barcode scanning
- Barcode generation for items

### Phase 2: Integration Enhancements (Q2 2025)

**ERPNext Push Integration:**
- Push verification results to ERPNext
- Create Stock Reconciliation entries
- Update item master data
- Bi-directional synchronization

**Third-Party Integrations:**
- Email notifications
- SMS alerts
- Cloud storage integration
- Analytics platform integration

### Phase 3: Advanced Features (Q3 2025)

**AI/ML Features:**
- Anomaly detection for variances
- Predictive analytics
- Image recognition for item identification
- Automated quality checks

**Multi-Warehouse Support:**
- Warehouse-specific configurations
- Cross-warehouse reporting
- Warehouse transfer tracking

**Mobile Enhancements:**
- Offline-first architecture
- Background sync
- Push notifications
- Widget support

### Phase 4: Enterprise Features (Q4 2025)

**Advanced Workflows:**
- Custom approval workflows
- Multi-level approvals
- Workflow automation
- Task assignment

**Enterprise Integrations:**
- ERPNext API integration (official)
- Third-party ERP support
- Warehouse Management System (WMS) integration
- Accounting system integration

**Advanced Analytics:**
- Business intelligence dashboards
- Predictive analytics
- Trend analysis
- Custom KPI tracking

---

## Appendix

### Glossary

- **Count Line:** A single item verification record within a session
- **Session:** A collection of count lines for a specific verification task
- **Variance:** Difference between system quantity and verified quantity
- **MRP:** Maximum Retail Price
- **UOM:** Unit of Measure
- **RBAC:** Role-Based Access Control
- **JWT:** JSON Web Token
- **ERPNext:** Enterprise Resource Planning system

### References

- ERPNext Documentation: https://docs.frappe.io
- FastAPI Documentation: https://fastapi.tiangolo.com
- React Native Documentation: https://reactnative.dev
- Expo Documentation: https://docs.expo.dev
- MongoDB Documentation: https://docs.mongodb.com

### Change Log

**Version 2.0 (2025-01-12):**
- Complete product specification document
- All sections filled out
- API specifications referenced
- User stories and use cases added
- Technical architecture documented

**Version 1.0 (Initial):**
- Basic product overview
- Initial feature list

---

**Document Status:** Complete
**Next Review Date:** 2025-04-12
**Owner:** Product Team
**Stakeholders:** Development Team, QA Team, Operations Team
